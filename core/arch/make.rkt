#lang rash
;; in-dir is in the demo file still
(require rash/demo/setup)
(require make)
(define (id x) x)
(define c-copyright "/*
    The Language
    Copyright (C) 2018, 2019  Zaoqi <zaomir@outlook.com>

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as published
    by the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.

*/
")
(define c-generatedby "/* Generated by make.rkt */\n")
(make
    (("ecmascript/lang.js" ("typescript/lang.ts") {
        in-dir "typescript" {
            touch lang.js
            rm lang.js
            npx tsc --build tsconfig.json
            (define raw #{cat lang.js})
            (define full (string-append
                c-generatedby
                "(function(){\n"
                raw
                "\n})();"
            ))
            echo $full &>! lang.full.js
            (define google-closure-exports (string-append
                c-generatedby
                "var exports = {};\n"
                #{grep "^exports." lang.full.js | awk (id "{print $1}") | sed (id "s|^\\(.*\\)$|\\1 = 'something';|")}
                ))
            echo $google-closure-exports &>! lang.externs.js
            npx google-closure-compiler -W QUIET --assume_function_wrapper --language_out ECMASCRIPT3 --js lang.full.js --externs lang.externs.js -O ADVANCED &>! lang.js
            cp lang.js ../ecmascript
            (define lang.pretty-print.js (string-append
                c-generatedby
                #{npx js-beautify lang.js}
                ))
            echo $lang.pretty-print.js &>! lang.pretty-print.js
        }})
     ("all" ("ecmascript/lang.js") (void)))
    (current-command-line-arguments))
